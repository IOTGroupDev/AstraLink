# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–†–ò–ì–ì–ï–†–ê OTP

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞!

–¢—Ä–∏–≥–≥–µ—Ä `on_auth_user_created` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —Å–æ–∑–¥–∞–Ω –Ω–∞ **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ô —Ç–∞–±–ª–∏—Ü–µ**:

```
‚úÖ Trigger name: on_auth_user_created
‚ùå Table: public.users  (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: auth.users)
```

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:**

- –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `public.users`
- –ù–û —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `auth.users`
- –ü–æ—ç—Ç–æ–º—É —Ç—Ä–∏–≥–≥–µ—Ä –ù–ò–ö–û–ì–î–ê –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- –ò —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è `auth.users` ‚Üí `public.users` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- OTP –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π "Database error saving new user"

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ù—É–∂–Ω–æ **–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä** —Å `public.users` –Ω–∞ `auth.users`.

### –í–∞—Ä–∏–∞–Ω—Ç 1: Supabase Dashboard (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Supabase Dashboard**
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–í–ï–°–¨** SQL –∏–∑ —Ñ–∞–π–ª–∞:
   ```
   backend/migrations/fix_trigger_placement.sql
   ```
4. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
5. –ù–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ Ctrl+Enter)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–∫—Ä–∏–ø—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å psql)

```bash
cd backend/migrations
./apply_trigger_fix.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ psql

```bash
psql "$DIRECT_URL" -f backend/migrations/fix_trigger_placement.sql
```

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è

1. **–£–¥–∞–ª—è–µ—Ç** –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Å `public.users`
2. **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç** —Ñ—É–Ω–∫—Ü–∏—é `handle_new_user()`
3. **–°–æ–∑–¥–∞–µ—Ç** –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ `auth.users`
4. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç** –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
SELECT
  trigger_name,
  event_object_schema,
  event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'on_auth_user_created';
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
trigger_name: on_auth_user_created
event_object_schema: auth          ‚Üê –í–ê–ñ–ù–û: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "auth"
event_object_table: users          ‚Üê users –≤ —Å—Ö–µ–º–µ auth
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ)
2. –û—Ç–∫—Ä–æ–π—Ç–µ —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. –í–≤–µ–¥–∏—Ç–µ email: `printbyall@gmail.com` (–∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π)
4. –ù–∞–∂–º–∏—Ç–µ "–î–ê–õ–ï–ï"
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

   ```
   ‚úÖ OTP –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
   ```

   **–ë–ï–ó –æ—à–∏–±–∫–∏** "Database error saving new user"

6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É - –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –∫–æ–¥
7. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
User enters email
  ‚Üì
signInWithOtp({shouldCreateUser: true})
  ‚Üì
Supabase creates user in auth.users
  ‚Üì
‚ùå Trigger on public.users NOT FIRED (wrong table!)
  ‚Üì
‚ùå No record in public.users
  ‚Üì
‚ùå Foreign key constraint violation
  ‚Üì
‚ùå "Database error saving new user"
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
User enters email
  ‚Üì
signInWithOtp({shouldCreateUser: true})
  ‚Üì
Supabase creates user in auth.users
  ‚Üì
‚úÖ Trigger on auth.users FIRES!
  ‚Üì
‚úÖ Function creates record in public.users
  ‚Üì
‚úÖ User successfully created
  ‚Üì
‚úÖ OTP sent
```

## üîç –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ:

1. –¢—Ä–∏–≥–≥–µ—Ä –±—ã–ª —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
2. –ò–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è redirect URLs –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–∏–ª–∞—Å—å

## üöÄ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

OTP –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è:

- ‚úÖ –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ OTP)
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ OTP)
- ‚úÖ OAuth (Google/Apple) - –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å `public.users`
- ‚úÖ –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

**–î–∞–π—Ç–µ –∑–Ω–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏!** üéØ
