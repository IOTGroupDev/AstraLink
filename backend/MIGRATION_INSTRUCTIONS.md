# Migration: Add ai_generated_at Column

## Problem
The `ai_generated_at` column doesn't exist in the database, causing Prisma errors:
```
The column `charts.ai_generated_at` does not exist in the current database.
```

## Solution: Manual Migration via Supabase Dashboard

Since the environment doesn't have direct database access, apply this migration manually:

### Steps:

1. **Go to Supabase Dashboard**
   - URL: https://ayoucajwdyinyhamousz.supabase.co
   - Navigate to: **SQL Editor**

2. **Run the following SQL:**

```sql
-- Add ai_generated_at field to charts table
-- This field tracks when the chart interpretation was generated by AI
-- Used for rate limiting (1 AI generation per 24 hours)

ALTER TABLE "public"."charts"
ADD COLUMN IF NOT EXISTS "ai_generated_at" TIMESTAMP WITH TIME ZONE;

-- Add index for efficient querying of recent AI generations
CREATE INDEX IF NOT EXISTS "charts_ai_generated_at_idx"
ON "public"."charts"("ai_generated_at");

-- Add comment to explain the field
COMMENT ON COLUMN "public"."charts"."ai_generated_at" IS 'Timestamp of last AI interpretation generation. Used for rate limiting (max 1 per 24 hours).';
```

3. **Verify the migration**

After running the SQL, verify it worked:

```sql
-- Check if column exists
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'charts'
  AND column_name = 'ai_generated_at';

-- Should return:
-- column_name      | data_type                   | is_nullable
-- ai_generated_at  | timestamp with time zone    | YES
```

4. **Restart the backend**

After applying the migration, restart the NestJS backend:

```bash
cd /home/user/AstraLink/backend
npm run start:dev
```

The error should disappear and AI chart regeneration will work correctly.

## What This Migration Does

- Adds `ai_generated_at` timestamp column to track AI generation time
- Creates index for efficient queries when checking rate limits
- Enables 24-hour rate limiting for AI chart regeneration feature

## Related Features

This migration supports:
- POST `/chart/regenerate-ai` endpoint
- 24-hour rate limiting (max 1 AI regeneration per day)
- Frontend regeneration button in ProfileScreen
