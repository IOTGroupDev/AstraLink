# üîß Supabase Troubleshooting Guide

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ—à–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º —Å Supabase –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π.

## ‚ùå –û—à–∏–±–∫–∞: "relation 'users' already exists"

### –ü—Ä–æ–±–ª–µ–º–∞
```
ERROR: 42P07: relation "users" already exists
```

### –ü—Ä–∏—á–∏–Ω–∞
–¢–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ Supabase, –Ω–æ —Å—Ö–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∏—Ö –∑–∞–Ω–æ–≤–æ.

### –†–µ—à–µ–Ω–∏–µ

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ö–µ–º—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–í Supabase SQL Editor** –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
   ```
   backend/supabase-schema-safe.sql
   ```

2. **–≠—Ç–∞ —Å—Ö–µ–º–∞:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CREATE TABLE IF NOT EXISTS`
   - –£–¥–∞–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!**

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–±—Ä–æ—Å–∞:**
   ```
   backend/supabase-reset.sql
   ```

2. **–ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ö–µ–º—É:**
   ```
   backend/supabase-schema-safe.sql
   ```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

1. **–í Supabase Dashboard** ‚Üí **Table Editor**
2. **–£–¥–∞–ª–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ø–æ—Ä—è–¥–∫–µ:**
   - `subscriptions`
   - `dating_matches`
   - `connections`
   - `charts`
   - `users`

3. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ö–µ–º—É**

## ‚ùå –û—à–∏–±–∫–∞: "function handle_new_user() already exists"

### –†–µ—à–µ–Ω–∏–µ
–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ö–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏:
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
```

## ‚ùå –û—à–∏–±–∫–∞: "policy already exists"

### –†–µ—à–µ–Ω–∏–µ
–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ö–µ–º–∞ —É–¥–∞–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏:
```sql
DROP POLICY IF EXISTS "Users can view own profile" ON public.users;
```

## ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env
cat backend/.env | grep SUPABASE
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```env
SUPABASE_URL="https://your-project.supabase.co"
SUPABASE_ANON_KEY="eyJ..."
SUPABASE_SERVICE_ROLE_KEY="eyJ..."
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```bash
# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
curl -H "apikey: YOUR_ANON_KEY" \
     -H "Authorization: Bearer YOUR_ANON_KEY" \
     "https://your-project.supabase.co/rest/v1/"
```

## ‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Auth

1. **–í Supabase Dashboard** ‚Üí **Authentication** ‚Üí **Settings**
2. **Site URL**: `http://localhost:3000`
3. **Redirect URLs**: 
   - `http://localhost:3000/api/auth/callback`
   - `http://localhost:8081`

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE schemaname = 'public';
```

## ‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±—ç–∫–µ–Ω–¥

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω
curl http://localhost:3000/api

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: "Hello World!"
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

```bash
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –±—ç–∫–µ–Ω–¥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏:
# ‚úÖ Supabase client initialized
# ‚úÖ Swiss Ephemeris –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü

```sql
-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ RLS

```sql
-- –°–ø–∏—Å–æ–∫ –ø–æ–ª–∏—Ç–∏–∫
SELECT tablename, policyname, cmd 
FROM pg_policies 
WHERE schemaname = 'public';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π

```sql
-- –°–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public';
```

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç:

1. **–£–¥–∞–ª–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç Supabase**
2. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç**
3. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ö–µ–º—É:**
   ```sql
   -- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ backend/supabase-schema-safe.sql
   -- –í—Å—Ç–∞–≤—å—Ç–µ –≤ Supabase SQL Editor
   -- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
   ```

## üìû –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–º–æ—â–∏

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
node scripts/test-supabase.js 2>&1 | tee supabase-test.log
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
echo "Backend status:"
curl -s http://localhost:3000/api && echo "‚úÖ Backend OK" || echo "‚ùå Backend DOWN"

echo "Supabase config:"
grep SUPABASE backend/.env && echo "‚úÖ Config OK" || echo "‚ùå Config MISSING"
```

## ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Supabase –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...

1Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Supabase...
‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!

2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Supabase...
‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!

3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã...
‚úÖ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!

4Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è...
‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–µ–Ω!

üéâ –í—Å–µ —Ç–µ—Å—Ç—ã Supabase –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
```
