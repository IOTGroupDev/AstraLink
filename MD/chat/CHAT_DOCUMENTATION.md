# ChatDialogScreen - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
- –ü–æ–∫–∞–∑ –ø–æ–Ω—è—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö

‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π**

- –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

‚úÖ **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π**

- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ API
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é

‚úÖ **Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**

- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Supabase
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏

‚úÖ **Polling**

- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- –ù–∞ —Å–ª—É—á–∞–π —Å–±–æ—è realtime –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

‚úÖ **UI/UX**

- –ö—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω
- –ê–≤–∞—Ç–∞—Ä—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
- –†–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ–∏—Ö/—á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏
- Empty state –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞

## üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞

```typescript
// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü–æ–ª—É—á–∞–µ—Ç—Å—è otherUserId –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
3. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è realtime –ø–æ–¥–ø–∏—Å–∫–∞
5. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è polling
```

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

```typescript
// –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:

1. –í–∞–ª–∏–¥–∞—Ü–∏—è (–µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç, –Ω–µ –∏–¥–µ—Ç –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∫–∞)
   if (!payload || sending || !user || !otherUserId) return;

2. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ API
   const response = await chatAPI.sendMessage(otherUserId, payload, null);

3. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É, –Ω–µ –∂–¥–µ–º —Å–µ—Ä–≤–µ—Ä–∞)
   setMessages((prev) => [...prev, optimisticMessage]);

4. –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
   setText('');

5. –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
   listRef.current?.scrollToEnd({ animated: true });

6. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è)
   setTimeout(() => fetchMessages(), 500);
```

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
// –î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è:

A. Realtime —á–µ—Ä–µ–∑ Supabase (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
   - –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ INSERT –≤ —Ç–∞–±–ª–∏—Ü–µ messages
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∏–∞–ª–æ–≥—É
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

B. Polling (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π, –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
   - –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
```

### 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏

```typescript
// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞:

1. –ó–∞–ø—Ä–æ—Å –∫ API: chatAPI.listMessages(otherUserId, 100)
2. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏: sort((a,b) => timeA - timeB)
4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ state: setMessages(sorted)
5. –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É: scrollToEnd()
```

## üîß API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã –∏–∑ chatAPI:

```typescript
// 1. –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
chatAPI.listMessages(userId: string, limit: number)
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: Message[]

// 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
chatAPI.sendMessage(recipientId: string, text: string, mediaPath: string | null)
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { success: boolean, id: string }
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Message:

```typescript
type Message = {
  id: string; // UUID —Å–æ–æ–±—â–µ–Ω–∏—è
  senderId: string; // ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  recipientId: string; // ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è
  text: string | null; // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  mediaPath: string | null; // –ü—É—Ç—å –∫ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  createdAt: string; // ISO –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
};
```

## üîÑ Realtime –ø–æ–¥–ø–∏—Å–∫–∞

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```typescript
supabase
  .channel(`messages-dialog-${user.id}-${otherUserId}`)
  .on(
    'postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'messages' },
    (payload) => {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const m = payload.new;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–∞—à–µ–º—É –¥–∏–∞–ª–æ–≥—É
      if (
        (m.sender_id === user.id && m.recipient_id === otherUserId) ||
        (m.sender_id === otherUserId && m.recipient_id === user.id)
      ) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
        setMessages((prev) => [...prev, newMessage]);
      }
    }
  )
  .subscribe();
```

## üé® UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–∫—Ä–∞–Ω–∞:

```
ChatDialogScreen
‚îú‚îÄ‚îÄ LinearGradient (—Ñ–æ–Ω)
‚îú‚îÄ‚îÄ KeyboardAvoidingView
‚îÇ   ‚îú‚îÄ‚îÄ Header
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ê–≤–∞—Ç–∞—Ä + –ò–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –ü—É—Å—Ç–æ–π –±–ª–æ–∫ (–¥–ª—è –±–∞–ª–∞–Ω—Å–∞)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ FlatList (—Å–æ–æ–±—â–µ–Ω–∏—è)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Message Item
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Bubble (—Å–≤–æ–π/—á—É–∂–æ–π —Å—Ç–∏–ª—å)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Text
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Time
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Input Container
‚îÇ       ‚îú‚îÄ‚îÄ TextInput (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π)
‚îÇ       ‚îî‚îÄ‚îÄ Send Button (—Å –∏–∫–æ–Ω–∫–æ–π)
```

### –°—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:

```typescript
// –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
- –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: —Å–ø—Ä–∞–≤–∞
- –¶–≤–µ—Ç: #8B5CF6 (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π)
- –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞: –º–µ–Ω—å—à–µ

// –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: —Å–ª–µ–≤–∞
- –¶–≤–µ—Ç: rgba(255,255,255,0.1) (–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π)
- –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞: –º–µ–Ω—å—à–µ
```

## üêõ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

1. **–ù–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞**

   ```typescript
   if (!otherUserId) {
     // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –æ—à–∏–±–∫–æ–π
     // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
   }
   ```

2. **–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω**

   ```typescript
   if (!user) {
     // Alert —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –≤–æ–π—Ç–∏
     // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω
   }
   ```

3. **–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏**

   ```typescript
   catch (error) {
     Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
   }
   ```

4. **–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏**
   ```typescript
   catch (error) {
     console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
     // UI –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   }
   ```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```typescript
// 1. –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
useEffect(() => {
  if (!user) {
    Alert.alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', ...);
  }
}, [user]);

// 2. –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
if (!user || !otherUserId) return;

// 3. –í API (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω)
api.post('/chat/messages/send', { ... }, {
  headers: { Authorization: `Bearer ${token}` }
});
```

## üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### KeyboardAvoidingView:

```typescript
<KeyboardAvoidingView
  behavior={Platform.OS === 'ios' ? 'padding' : undefined}
  keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 0}
>
```

### –ü–æ–ª–µ –≤–≤–æ–¥–∞:

```typescript
<View style={styles.inputContainer}>
  paddingBottom: Platform.OS === 'ios' ? 32 : 16
</View>
```

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI

- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
- –ù–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Alert

### 2. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

```typescript
setMessages((prev) => {
  if (prev.some((x) => x.id === m.id)) return prev;
  return [...prev, newMessage];
});
```

### 3. –ú–µ–º–æ–∏–∑–∞—Ü–∏—è

```typescript
const fetchMessages = useCallback(async () => { ... }, [otherUserId, user]);
const onSend = useCallback(async () => { ... }, [text, sending, ...]);
const renderItem = useCallback(({ item }) => { ... }, [user]);
```

### 4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

- Polling: –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 5 —Å–µ–∫—É–Ω–¥
- Realtime: —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞

## üìù –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é: `console.log(user)`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å otherUserId: `console.log(otherUserId)`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç API: –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `fetchMessages`

### –ü—Ä–æ–±–ª–µ–º–∞: –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç: `text.trim()` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –ø—É—Å—Ç—ã–º
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–ª–∞–≥ sending
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç API
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º–∞: Realtime –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: `console.log('Channel subscribed')`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –≤ `.on(...)`
3. Fallback –Ω–∞ polling –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä—É—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**

- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã:

```typescript
if (prev.some((x) => x.id === m.id)) return prev;
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏—è

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç
   ‚Üì
2. –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
   ‚Üì
3. –í–∞–ª–∏–¥–∞—Ü–∏—è (—Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π, –Ω–µ –∏–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞)
   ‚Üì
4. setSending(true) ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
   ‚Üì
5. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: chatAPI.sendMessage()
   ‚Üì
6. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ messages)
   ‚Üì
7. –ü–æ–ª—É—á–∞–µ–º response.id
   ‚Üì
8. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª—è–µ–º –≤ messages[]
   ‚Üì
9. setText('') ‚Üí –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
   ‚Üì
10. scrollToEnd() ‚Üí –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É
   ‚Üì
11. Realtime –ø–æ–ª—É—á–∞–µ—Ç INSERT –æ—Ç Supabase
   ‚Üì
12. –ï—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
   ‚Üì
13. setSending(false) ‚Üí —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
```

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```json
{
  "@react-navigation/native": "–¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏",
  "expo-linear-gradient": "–¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤",
  "@expo/vector-icons": "–¥–ª—è –∏–∫–æ–Ω–æ–∫",
  "react-native-reanimated": "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞",
  "../services/api": "chatAPI –º–µ—Ç–æ–¥—ã",
  "../contexts/AuthContext": "useAuth hook",
  "../services/supabase": "realtime –ø–æ–¥–ø–∏—Å–∫–∏"
}
```

## üéØ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
3. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
4. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
5. ‚úÖ Realtime —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞)
6. ‚úÖ Polling —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è realtime)
7. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
8. ‚úÖ UI –≤—ã–≥–ª—è–¥–∏—Ç —Ö–æ—Ä–æ—à–æ –Ω–∞ iOS –∏ Android
9. ‚úÖ –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ª–µ –≤–≤–æ–¥–∞
10. ‚úÖ –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ API:

1. **GET /chat/messages?userId={userId}&limit={limit}**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ auth.uid() –∏ userId
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ created_at

2. **POST /chat/messages/send**

   ```json
   {
     "recipientId": "uuid",
     "text": "–ü—Ä–∏–≤–µ—Ç!",
     "mediaPath": null
   }
   ```

   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ messages
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { success: true, id: "uuid" }

3. **Supabase RLS (Row Level Security)**

   ```sql
   -- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è
   CREATE POLICY "Users can read own messages"
   ON messages FOR SELECT
   USING (
     auth.uid() = sender_id OR
     auth.uid() = recipient_id
   );

   -- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
   CREATE POLICY "Users can send messages"
   ON messages FOR INSERT
   WITH CHECK (auth.uid() = sender_id);
   ```

## üé® –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç–∞:

```typescript
// –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
bubbleMine: {
  backgroundColor: '#8B5CF6', // –ò–∑–º–µ–Ω–∏—Ç–µ –∑–¥–µ—Å—å
}

// –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
bubbleOther: {
  backgroundColor: 'rgba(255, 255, 255, 0.1)', // –ò–∑–º–µ–Ω–∏—Ç–µ –∑–¥–µ—Å—å
}
```

### –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª polling:

```typescript
const intervalId = setInterval(() => {
  fetchMessages().catch(() => void 0);
}, 5000); // –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –º—Å
```

### –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–µ–¥–∏–∞:

```typescript
// –í renderItem –¥–æ–±–∞–≤—å—Ç–µ:
if (item.mediaPath) {
  return <Image source={{ uri: item.mediaPath }} style={styles.media} />;
}
```
